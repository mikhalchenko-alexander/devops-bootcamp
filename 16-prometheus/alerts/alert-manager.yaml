apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: main-rules-alert-config
  namespace: monitoring
spec:
  route:
    repeatInterval: 30m
    receiver: 'slack'
    routes:
    - receiver: 'slack'
      matchers:
      - name: alertname
        matchType: "=~"
        value: 'All instances down|Too many connections|TooManyRequests'
    - receiver: 'email'
      matchers:
      - name: alertname
        matchType: "=~"
        value: "Nginx4xxRateHigh|StatefulSetReplicasMismatch"

  receivers:
  - name: 'email'
    emailConfigs:
    - to: 'email@example.com'
      from: 'email@example.com'
      smarthost: 'smtp.gmail.com:587'
      authUsername: 'email@example.com'
      authIdentity: 'email@example.com'
      authPassword:
        name: gmail-auth
        key: password

  - name: 'slack'
    slackConfigs:
    - channel: '#prometheus-alerts'
      sendResolved: false
      apiURL:
        name: slack-auth
        key: slack-url
      title: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] Monitoring Event Notification'
      text: >-
        {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }} - `{{ .Labels.severity }}`
          *Description:* {{ .Annotations.description }}
          *Graph:* <{{ .GeneratorURL }}|:chart_with_upwards_trend:> *Runbook:* <{{ .Annotations.runbook }}|:spiral_note_pad:>
          *Details:*
          {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
          {{ end }}
        {{ end }}
              
